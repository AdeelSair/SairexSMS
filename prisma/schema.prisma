// SAIREX SMS — Enterprise SaaS Onboarding + Multi-Tenant RBAC Schema

generator client {
  provider                    = "prisma-client-py"
  enable_experimental_decimal = true
}

generator jsClient {
  provider = "prisma-client-js"
  output   = "../web/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////////////////////////////////////////////
/// ENUMS
////////////////////////////////////////////////////////////

enum PlatformRole {
  SUPER_ADMIN
  SUPPORT
}

enum MembershipRole {
  ORG_ADMIN

  REGION_ADMIN
  SUBREGION_ADMIN
  ZONE_ADMIN
  CAMPUS_ADMIN

  TEACHER
  ACCOUNTANT
  PARENT
  STAFF
}

enum MembershipStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

enum OrganizationCategory {
  SCHOOL
  COLLEGE
  ACADEMY
  INSTITUTE
  UNIVERSITY
  OTHERS
}

enum OrganizationStructure {
  SINGLE
  MULTIPLE
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  ARCHIVED
}

enum OnboardingStep {
  ORG_IDENTITY
  LEGAL
  CONTACT_ADDRESS
  BRANDING
  COMPLETED
}

enum AddressType {
  HEAD_OFFICE
  BILLING
  CAMPUS
  OTHER
}

enum UnitScopeType {
  REGION
  SUBREGION
  CITY
  ZONE
  CAMPUS
}

enum UnitStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum MediaType {
  LOGO
  FAVICON
  DOCUMENT
}

enum MediaVariant {
  ORIGINAL
  SM
  MD
  LG
  DARK
  PRINT
}

enum AuditAction {
  MEMBERSHIP_INVITED
  MEMBERSHIP_ROLE_CHANGED
  MEMBERSHIP_SCOPE_CHANGED
  MEMBERSHIP_REVOKED
  MEMBERSHIP_REACTIVATED
  PAYMENT_RECONCILED
  PAYMENT_REVERSED
  PAYMENT_FAILED
  FEE_POSTING_STARTED
  FEE_POSTING_COMPLETED
  FEE_POSTING_FAILED
}

enum FinanceRoutingMode {
  CAMPUS_PRIMARY
  NEAREST_PARENT_PRIMARY
}

enum PaymentChannel {
  OTC
  BANK_TRANSFER
  ONLINE_GATEWAY
  MOBILE_WALLET
  ONEBILL
  OTHER
}

enum PaymentStatus {
  PENDING
  RECONCILED
  FAILED
  REFUNDED
}

enum ChallanStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  CANCELLED
}

enum LedgerEntryType {
  CHALLAN_CREATED
  PAYMENT_RECEIVED
  ADJUSTMENT
  REFUND
  WAIVER
}

enum LedgerDirection {
  DEBIT
  CREDIT
}

enum FeeFrequency {
  MONTHLY
  TERM
  ANNUAL
}

enum PostingRunStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ReminderChannel {
  SMS
  WHATSAPP
  EMAIL
}

enum ReminderStatus {
  SENT
  FAILED
  DELIVERED
}

////////////////////////////////////////////////////////////
/// USER (GLOBAL IDENTITY)
////////////////////////////////////////////////////////////

model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  password String
  name     String?
  isActive Boolean @default(false)

  emailVerifiedAt    DateTime?
  emailVerifyToken   String?   @unique
  emailVerifyExpires DateTime?

  platformRole PlatformRole?

  tokenVersion Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships       Membership[]
  createdOrgs       Organization[]       @relation("OrgCreator")
  sentInvitations   Invitation[]
  resetTokens       PasswordResetToken[]
  verificationCodes VerificationCode[]
  jobs              Job[]

  auditActionsPerformed RbacAuditLog[] @relation("AuditActor")
  auditActionsReceived  RbacAuditLog[] @relation("AuditTarget")
  postingRuns           PostingRun[]
}

////////////////////////////////////////////////////////////
/// ONBOARDING VERIFICATION CODES
////////////////////////////////////////////////////////////

model VerificationCode {
  id          String    @id @default(cuid())
  userId      Int
  channel     String // "email" | "mobile" | "whatsapp"
  target      String // email address or phone number
  codeHash    String // SHA-256 hex digest of the 6-digit OTP
  expiresAt   DateTime
  verified    Boolean   @default(false)
  verifiedAt  DateTime?
  attempts    Int       @default(0)
  lockedUntil DateTime?
  createdAt   DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, channel, target])
}

////////////////////////////////////////////////////////////
/// ORGANIZATION ID SEQUENCE (Race-safe)
////////////////////////////////////////////////////////////

model OrganizationSequence {
  id        Int @id @default(1)
  lastValue Int @default(0)
}

////////////////////////////////////////////////////////////
/// ORGANIZATION (TENANT ROOT — Flat Single Table)
////////////////////////////////////////////////////////////

model Organization {
  /// System
  id             String             @id @db.VarChar(11)
  slug           String             @unique
  status         OrganizationStatus @default(ACTIVE)
  onboardingStep OnboardingStep     @default(ORG_IDENTITY)

  createdByUserId Int
  createdBy       User @relation("OrgCreator", fields: [createdByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Core Identity (Step 1: ORG_IDENTITY)
  organizationName      String
  displayName           String
  organizationCategory  OrganizationCategory
  organizationStructure OrganizationStructure

  /// Legal (Step 2: LEGAL — nullable until filled)
  registrationNumber String?
  taxNumber          String?
  establishedDate    DateTime? @db.Date

  /// HQ Address (Step 3: CONTACT_ADDRESS — nullable until filled)
  addressLine1  String?
  addressLine2  String?
  country       String?
  provinceState String?
  district      String?
  tehsil        String?
  city          String?
  postalCode    String?

  /// Contact (Step 3: CONTACT_ADDRESS — nullable until filled)
  organizationEmail    String?
  organizationPhone    String?
  organizationMobile   String?
  organizationWhatsApp String?
  websiteUrl           String?

  /// Branding (Step 4: BRANDING — always optional)
  logoUrl       String?
  logoKey       String?
  logoUpdatedAt DateTime?
  logoLightUrl  String?
  logoDarkUrl   String?
  logoPrintUrl  String?

  /// Finance
  financeRoutingMode FinanceRoutingMode @default(CAMPUS_PRIMARY)

  // Relations
  memberships Membership[]
  mediaAssets MediaAsset[]
  invitations Invitation[]
  jobs        Job[]

  contacts     OrganizationContact[]
  addresses    OrganizationAddress[]
  bankAccounts OrganizationBank[]

  campuses      Campus[]
  students      Student[]
  feeHeads      FeeHead[]
  feeStructures FeeStructure[]
  feeChallans   FeeChallan[]

  regions            Region[]
  subRegions         SubRegion[]
  cities             City[]
  zones              Zone[]
  unitCodeSequences  UnitCodeSequence[]
  unitProfiles       UnitProfile[]
  unitBankAccounts   UnitBankAccount[]
  rbacAuditLogs      RbacAuditLog[]
  paymentRecords     PaymentRecord[]
  ledgerEntries      LedgerEntry[]
  financialSummaries StudentFinancialSummary[]
  postingRuns        PostingRun[]
  reminderRules      ReminderRule[]
  reminderLogs       ReminderLog[]

  @@index([status])
}

////////////////////////////////////////////////////////////
/// ORGANIZATION CONTACTS
////////////////////////////////////////////////////////////

model OrganizationContact {
  id             Int    @id @default(autoincrement())
  organizationId String

  name        String
  designation String?
  email       String?
  phone       String?

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

////////////////////////////////////////////////////////////
/// ORGANIZATION ADDRESSES
////////////////////////////////////////////////////////////

model OrganizationAddress {
  id             Int    @id @default(autoincrement())
  organizationId String

  type AddressType

  country    String
  province   String
  city       String
  area       String?
  postalCode String?

  addressLine1 String
  addressLine2 String?

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

////////////////////////////////////////////////////////////
/// ORGANIZATION BANK ACCOUNTS
////////////////////////////////////////////////////////////

model OrganizationBank {
  id             Int    @id @default(autoincrement())
  organizationId String

  accountTitle  String
  bankName      String
  branchName    String?
  accountNumber String
  iban          String?
  swiftCode     String?

  isPrimary Boolean @default(false)

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

////////////////////////////////////////////////////////////
/// UNIT CODE SEQUENCE (Race-safe auto-increment per scope)
////////////////////////////////////////////////////////////

model UnitCodeSequence {
  id             String        @id @default(cuid())
  scopeType      UnitScopeType
  scopeId        String?
  organizationId String        @db.VarChar(11)
  lastValue      Int           @default(0)

  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, scopeType, scopeId])
}

////////////////////////////////////////////////////////////
/// GEO HIERARCHY: Region → SubRegion → City → Zone
////////////////////////////////////////////////////////////

model Region {
  id             String     @id @default(cuid())
  name           String
  unitCode       String     @db.VarChar(5)
  organizationId String     @db.VarChar(11)
  status         UnitStatus @default(ACTIVE)

  organization Organization @relation(fields: [organizationId], references: [id])
  subRegions   SubRegion[]
  cities       City[]

  @@unique([organizationId, unitCode])
}

model SubRegion {
  id             String     @id @default(cuid())
  name           String
  unitCode       String     @db.VarChar(5)
  organizationId String     @db.VarChar(11)
  status         UnitStatus @default(ACTIVE)

  regionId String?
  region   Region? @relation(fields: [regionId], references: [id])

  organization Organization @relation(fields: [organizationId], references: [id])
  cities       City[]

  @@unique([organizationId, regionId, unitCode])
}

model City {
  id             String     @id @default(cuid())
  name           String
  unitCode       String     @db.VarChar(5)
  organizationId String     @db.VarChar(11)
  status         UnitStatus @default(ACTIVE)

  regionId    String?
  subRegionId String?

  region       Region?      @relation(fields: [regionId], references: [id])
  subRegion    SubRegion?   @relation(fields: [subRegionId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  zones    Zone[]
  campuses Campus[]

  @@unique([organizationId, unitCode])
}

model Zone {
  id             String     @id @default(cuid())
  name           String
  unitCode       String     @db.VarChar(5)
  organizationId String     @db.VarChar(11)
  status         UnitStatus @default(ACTIVE)

  cityId String
  city   City   @relation(fields: [cityId], references: [id])

  organization Organization @relation(fields: [organizationId], references: [id])
  campuses     Campus[]

  @@unique([organizationId, cityId, unitCode])
}

////////////////////////////////////////////////////////////
/// CAMPUS (Operational Unit)
////////////////////////////////////////////////////////////

model Campus {
  id             Int          @id @default(autoincrement())
  organizationId String       @db.VarChar(11)
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  campusCode     String       @unique
  campusSlug     String       @unique
  unitCode       String       @db.VarChar(5)
  fullUnitPath   String       @db.VarChar(50)
  address        String?

  cityId String
  city   City   @relation(fields: [cityId], references: [id])

  zoneId String?
  zone   Zone?   @relation(fields: [zoneId], references: [id])

  principalName      String?
  contactPhone       String?
  email              String?
  academicStartMonth Int       @default(8)
  isMainCampus       Boolean   @default(false)
  status             String    @default("ACTIVE")
  createdAt          DateTime  @default(now())
  deletedAt          DateTime?

  memberships   Membership[]
  students      Student[]
  feeStructures FeeStructure[]
  feeChallans   FeeChallan[]
  ledgerEntries LedgerEntry[]
  reminderRules ReminderRule[]

  @@index([fullUnitPath])
}

////////////////////////////////////////////////////////////
/// UNIT ADMINISTRATION (Profile, Contacts, Addresses)
////////////////////////////////////////////////////////////

model UnitProfile {
  id             String        @id @default(cuid())
  organizationId String        @db.VarChar(11)
  unitType       UnitScopeType
  unitId         String

  displayName String?
  email       String?
  phone       String?
  mobile      String?
  whatsapp    String?
  websiteUrl  String?
  logoUrl     String?

  status UnitStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts     UnitContact[]
  addresses    UnitAddress[]
  bankAccounts UnitBankAccount[]

  @@unique([unitType, unitId])
  @@index([organizationId])
}

model UnitContact {
  id            String @id @default(cuid())
  unitProfileId String

  name        String
  designation String?
  email       String?
  phone       String?
  mobile      String?

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  unitProfile UnitProfile @relation(fields: [unitProfileId], references: [id], onDelete: Cascade)

  @@index([unitProfileId])
}

model UnitAddress {
  id            String @id @default(cuid())
  unitProfileId String

  country      String
  province     String
  city         String
  area         String?
  addressLine1 String
  addressLine2 String?
  postalCode   String?

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  unitProfile UnitProfile @relation(fields: [unitProfileId], references: [id], onDelete: Cascade)

  @@index([unitProfileId])
}

////////////////////////////////////////////////////////////
/// UNIT BANK ACCOUNTS (Financial Identity per Unit)
////////////////////////////////////////////////////////////

model UnitBankAccount {
  id String @id @default(cuid())

  organizationId String @db.VarChar(11)
  unitProfileId  String

  bankName   String
  branchName String?
  branchCode String?

  accountTitle  String
  accountNumber String
  iban          String? @db.VarChar(34)

  swiftCode String? @db.VarChar(11)

  isPrimary Boolean @default(false)

  status UnitStatus @default(ACTIVE)

  notes String? @db.VarChar(500)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  unitProfile    UnitProfile     @relation(fields: [unitProfileId], references: [id], onDelete: Cascade)
  feeChallans    FeeChallan[]
  paymentRecords PaymentRecord[]

  @@index([organizationId])
  @@index([unitProfileId])
  @@index([status])
}

////////////////////////////////////////////////////////////
/// MEMBERSHIP (TENANT RBAC BRIDGE)
////////////////////////////////////////////////////////////

model Membership {
  id Int @id @default(autoincrement())

  userId         Int
  organizationId String

  role   MembershipRole
  status MembershipStatus @default(ACTIVE)

  campusId Int?

  unitId   String?
  unitPath String? @db.VarChar(50)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  campus       Campus?      @relation(fields: [campusId], references: [id])

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([unitPath])
  @@index([role, unitPath])
}

////////////////////////////////////////////////////////////
/// INVITATIONS
////////////////////////////////////////////////////////////

model Invitation {
  id Int @id @default(autoincrement())

  email          String
  organizationId String
  role           MembershipRole

  token String @unique

  invitedById Int
  invitedBy   User @relation(fields: [invitedById], references: [id])

  expiresAt  DateTime
  acceptedAt DateTime?

  organization Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())

  @@index([organizationId])
}

////////////////////////////////////////////////////////////
/// PASSWORD RESET TOKENS
////////////////////////////////////////////////////////////

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation(fields: [userId], references: [id])
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
}

////////////////////////////////////////////////////////////
/// STUDENT
////////////////////////////////////////////////////////////

model Student {
  id          Int    @id @default(autoincrement())
  fullName    String
  admissionNo String @unique
  grade       String
  feeStatus   String @default("Unpaid")

  organizationId String       @db.VarChar(11)
  organization   Organization @relation(fields: [organizationId], references: [id])
  campusId       Int
  campus         Campus       @relation(fields: [campusId], references: [id])

  feeChallans      FeeChallan[]
  ledgerEntries    LedgerEntry[]
  financialSummary StudentFinancialSummary?
  reminderLogs     ReminderLog[]
}

model StudentFinancialSummary {
  studentId      Int    @id
  organizationId String @db.VarChar(11)
  campusId       Int

  totalDebit  Decimal @default(0) @db.Decimal(12, 2)
  totalCredit Decimal @default(0) @db.Decimal(12, 2)
  balance     Decimal @default(0) @db.Decimal(12, 2)

  updatedAt DateTime @updatedAt

  student      Student      @relation(fields: [studentId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([organizationId, campusId])
  @@index([balance])
}

////////////////////////////////////////////////////////////
/// FEE POSTING RUN (Idempotency Guard)
////////////////////////////////////////////////////////////

model PostingRun {
  id             String @id @default(cuid())
  organizationId String @db.VarChar(11)

  month Int
  year  Int

  campusId Int?

  status      PostingRunStatus @default(PENDING)
  startedAt   DateTime         @default(now())
  completedAt DateTime?

  totalStudents Int     @default(0)
  totalChallans Int     @default(0)
  totalAmount   Decimal @default(0) @db.Decimal(12, 2)

  errorMessage String?

  createdByUserId Int?
  createdByUser   User?        @relation(fields: [createdByUserId], references: [id])
  organization    Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, month, year])
  @@index([organizationId])
  @@index([status])
}

////////////////////////////////////////////////////////////
/// REMINDER ENGINE (Automated Collection)
////////////////////////////////////////////////////////////

model ReminderRule {
  id             String @id @default(cuid())
  organizationId String @db.VarChar(11)
  campusId       Int?

  name           String
  minDaysOverdue Int
  maxDaysOverdue Int?

  channel  ReminderChannel
  template String          @db.Text

  frequencyDays Int @default(7)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id])
  campus       Campus?       @relation(fields: [campusId], references: [id])
  reminderLogs ReminderLog[]

  @@index([organizationId, isActive])
}

model ReminderLog {
  id             String @id @default(cuid())
  organizationId String @db.VarChar(11)
  studentId      Int
  challanId      Int?
  reminderRuleId String

  channel ReminderChannel
  sentAt  DateTime        @default(now())
  status  ReminderStatus

  messageBody String? @db.Text
  externalRef String?
  errorDetail String?

  organization Organization @relation(fields: [organizationId], references: [id])
  student      Student      @relation(fields: [studentId], references: [id])
  challan      FeeChallan?  @relation(fields: [challanId], references: [id])
  reminderRule ReminderRule @relation(fields: [reminderRuleId], references: [id])

  @@index([studentId, reminderRuleId, sentAt])
  @@index([organizationId])
  @@index([challanId])
}

////////////////////////////////////////////////////////////
/// FEE MODULE
////////////////////////////////////////////////////////////

model FeeHead {
  id              Int          @id @default(autoincrement())
  organizationId  String       @db.VarChar(11)
  organization    Organization @relation(fields: [organizationId], references: [id])
  name            String
  type            String
  isSystemDefault Boolean      @default(false)
  createdAt       DateTime     @default(now())

  structures FeeStructure[]
}

model FeeStructure {
  id             Int          @id @default(autoincrement())
  organizationId String       @db.VarChar(11)
  campusId       Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  campus         Campus       @relation(fields: [campusId], references: [id])

  feeHeadId Int
  feeHead   FeeHead @relation(fields: [feeHeadId], references: [id])

  name      String
  amount    Decimal      @default(0.00) @db.Decimal(12, 2)
  currency  String       @default("PKR")
  frequency FeeFrequency @default(MONTHLY)

  applicableGrade String?
  startMonth      Int?
  endMonth        Int?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  feeChallans FeeChallan[]

  @@index([organizationId, isActive])
}

model FeeChallan {
  id             Int          @id @default(autoincrement())
  organizationId String       @db.VarChar(11)
  campusId       Int
  studentId      Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  campus         Campus       @relation(fields: [campusId], references: [id])
  student        Student      @relation(fields: [studentId], references: [id])

  challanNo String   @unique
  issueDate DateTime @default(now())
  dueDate   DateTime

  totalAmount Decimal       @db.Decimal(12, 2)
  paidAmount  Decimal       @default(0.00) @db.Decimal(12, 2)
  status      ChallanStatus @default(UNPAID)

  paymentMethod String?
  paidAt        DateTime?

  generatedBy String

  month          Int?
  year           Int?
  feeStructureId Int?
  feeStructure   FeeStructure? @relation(fields: [feeStructureId], references: [id])

  bankAccountId String?
  bankAccount   UnitBankAccount? @relation(fields: [bankAccountId], references: [id])

  paymentRecords PaymentRecord[]
  ledgerEntries  LedgerEntry[]
  reminderLogs   ReminderLog[]

  @@unique([studentId, month, year, feeStructureId])
  @@index([bankAccountId])
  @@index([organizationId])
  @@index([studentId])
  @@index([status])
  @@index([feeStructureId])
}

////////////////////////////////////////////////////////////
/// PAYMENT RECORD (Raw Incoming Money)
////////////////////////////////////////////////////////////

model PaymentRecord {
  id             String  @id @default(cuid())
  organizationId String  @db.VarChar(11)
  bankAccountId  String?

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("PKR")

  transactionRef String?
  paymentChannel PaymentChannel

  paidAt     DateTime
  receivedAt DateTime @default(now())

  status PaymentStatus @default(PENDING)

  rawPayload Json?

  challanId Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id])
  bankAccount  UnitBankAccount? @relation(fields: [bankAccountId], references: [id])
  challan      FeeChallan?      @relation(fields: [challanId], references: [id])

  @@index([organizationId])
  @@index([transactionRef])
  @@index([challanId])
  @@index([status])
}

////////////////////////////////////////////////////////////
/// LEDGER ENTRY (Financial Truth Layer)
////////////////////////////////////////////////////////////

model LedgerEntry {
  id             String @id @default(cuid())
  organizationId String @db.VarChar(11)
  studentId      Int?
  campusId       Int?
  challanId      Int?

  entryType LedgerEntryType
  direction LedgerDirection
  amount    Decimal         @db.Decimal(12, 2)

  referenceId   String?
  referenceType String?

  notes String?

  entryDate DateTime @default(now())
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  student      Student?     @relation(fields: [studentId], references: [id])
  campus       Campus?      @relation(fields: [campusId], references: [id])
  challan      FeeChallan?  @relation(fields: [challanId], references: [id])

  @@index([organizationId, studentId])
  @@index([studentId, entryDate])
  @@index([challanId])
  @@index([campusId])
  @@index([entryType])
}

////////////////////////////////////////////////////////////
/// BACKGROUND JOB (Queue Audit Trail)
////////////////////////////////////////////////////////////

model Job {
  id          String    @id @default(cuid())
  type        String // EMAIL, SMS, WHATSAPP, CHALLAN_PDF, REPORT, IMPORT, OTP
  queue       String    @default("default")
  payload     Json
  status      String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, DEAD
  priority    Int       @default(0)
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?
  error       String?
  result      Json?

  organizationId String? @db.VarChar(11)
  userId         Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id])
  user         User?         @relation(fields: [userId], references: [id])

  @@index([status, scheduledAt])
  @@index([type, status])
  @@index([organizationId])
  @@index([queue, priority])
}

////////////////////////////////////////////////////////////
/// MEDIA ASSETS
////////////////////////////////////////////////////////////

model MediaAsset {
  id             String       @id @default(cuid())
  organizationId String       @db.VarChar(11)
  type           MediaType
  variant        MediaVariant @default(ORIGINAL)
  url            String
  key            String
  size           Int
  mimeType       String
  width          Int?
  height         Int?
  originalName   String?
  createdBy      String?
  version        Int          @default(1)
  createdAt      DateTime     @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, type])
  @@index([organizationId, type, variant])
}

////////////////////////////////////////////////////////////
/// RBAC AUDIT LOG
////////////////////////////////////////////////////////////

model RbacAuditLog {
  id String @id @default(cuid())

  organizationId String      @db.VarChar(11)
  action         AuditAction

  actorUserId  Int
  targetUserId Int
  membershipId Int

  oldRole MembershipRole?
  newRole MembershipRole?

  oldUnitPath String? @db.VarChar(50)
  newUnitPath String? @db.VarChar(50)

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actor        User         @relation("AuditActor", fields: [actorUserId], references: [id])
  target       User         @relation("AuditTarget", fields: [targetUserId], references: [id])

  @@index([organizationId, createdAt])
  @@index([membershipId])
  @@index([targetUserId])
}
