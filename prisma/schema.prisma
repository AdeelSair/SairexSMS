// SAIREX SMS — Enterprise SaaS Onboarding + Multi-Tenant RBAC Schema

generator client {
  provider = "prisma-client-py"
  enable_experimental_decimal = true
}

generator jsClient {
  provider = "prisma-client-js"
  output   = "../web/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////////////////////////////////////////////
/// ENUMS
////////////////////////////////////////////////////////////

enum PlatformRole {
  SUPER_ADMIN
  SUPPORT
}

enum MembershipRole {
  ORG_ADMIN
  CAMPUS_ADMIN
  TEACHER
  ACCOUNTANT
  PARENT
  STAFF
}

enum MembershipStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

enum OrganizationCategory {
  SCHOOL
  COLLEGE
  ACADEMY
  INSTITUTE
  UNIVERSITY
  OTHERS
}

enum OrganizationStructure {
  SINGLE
  MULTIPLE
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  ARCHIVED
}

enum OnboardingStep {
  ORG_IDENTITY
  LEGAL
  CONTACT_ADDRESS
  BRANDING
  COMPLETED
}

enum AddressType {
  HEAD_OFFICE
  BILLING
  CAMPUS
  OTHER
}

enum UnitScopeType {
  REGION
  SUBREGION
  CITY
  ZONE
  CAMPUS
}

////////////////////////////////////////////////////////////
/// USER (GLOBAL IDENTITY)
////////////////////////////////////////////////////////////

model User {
  id                 Int       @id @default(autoincrement())
  email              String    @unique
  password           String
  name               String?
  isActive           Boolean   @default(false)

  emailVerifiedAt    DateTime?
  emailVerifyToken   String?   @unique
  emailVerifyExpires DateTime?

  platformRole       PlatformRole?

  tokenVersion       Int       @default(0)

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  memberships        Membership[]
  createdOrgs        Organization[]     @relation("OrgCreator")
  sentInvitations    Invitation[]
  resetTokens        PasswordResetToken[]
  verificationCodes  VerificationCode[]
  jobs               Job[]
}

////////////////////////////////////////////////////////////
/// ONBOARDING VERIFICATION CODES
////////////////////////////////////////////////////////////

model VerificationCode {
  id           String    @id @default(cuid())
  userId       Int
  channel      String    // "email" | "mobile" | "whatsapp"
  target       String    // email address or phone number
  codeHash     String    // SHA-256 hex digest of the 6-digit OTP
  expiresAt    DateTime
  verified     Boolean   @default(false)
  verifiedAt   DateTime?
  attempts     Int       @default(0)
  lockedUntil  DateTime?
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, channel, target])
}

////////////////////////////////////////////////////////////
/// ORGANIZATION ID SEQUENCE (Race-safe)
////////////////////////////////////////////////////////////

model OrganizationSequence {
  id        Int @id @default(1)
  lastValue Int @default(0)
}

////////////////////////////////////////////////////////////
/// ORGANIZATION (TENANT ROOT — Flat Single Table)
////////////////////////////////////////////////////////////

model Organization {
  /// System
  id               String              @id @db.VarChar(11)
  slug             String              @unique
  status           OrganizationStatus  @default(ACTIVE)
  onboardingStep   OnboardingStep      @default(ORG_IDENTITY)

  createdByUserId  Int
  createdBy        User                @relation("OrgCreator", fields: [createdByUserId], references: [id])

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  /// Core Identity (Step 1: ORG_IDENTITY)
  organizationName String
  displayName      String
  organizationCategory  OrganizationCategory
  organizationStructure OrganizationStructure

  /// Legal (Step 2: LEGAL — nullable until filled)
  registrationNumber String?
  taxNumber          String?
  establishedDate    DateTime?          @db.Date

  /// HQ Address (Step 3: CONTACT_ADDRESS — nullable until filled)
  addressLine1     String?
  addressLine2     String?
  country          String?
  provinceState    String?
  district         String?
  tehsil           String?
  city             String?
  postalCode       String?

  /// Contact (Step 3: CONTACT_ADDRESS — nullable until filled)
  organizationEmail     String?
  organizationPhone     String?
  organizationMobile    String?
  organizationWhatsApp  String?
  websiteUrl            String?

  /// Branding (Step 4: BRANDING — always optional)
  logoUrl          String?

  // Relations
  memberships       Membership[]
  invitations       Invitation[]
  jobs              Job[]

  contacts          OrganizationContact[]
  addresses         OrganizationAddress[]
  bankAccounts      OrganizationBank[]

  campuses          Campus[]
  students          Student[]
  feeHeads          FeeHead[]
  feeStructures     FeeStructure[]
  feeChallans       FeeChallan[]

  @@index([status])
}

////////////////////////////////////////////////////////////
/// ORGANIZATION CONTACTS
////////////////////////////////////////////////////////////

model OrganizationContact {
  id              Int          @id @default(autoincrement())
  organizationId  String

  name            String
  designation     String?
  email           String?
  phone           String?

  isPrimary       Boolean      @default(false)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

////////////////////////////////////////////////////////////
/// ORGANIZATION ADDRESSES
////////////////////////////////////////////////////////////

model OrganizationAddress {
  id              Int          @id @default(autoincrement())
  organizationId  String

  type            AddressType

  country         String
  province        String
  city            String
  area            String?
  postalCode      String?

  addressLine1    String
  addressLine2    String?

  isPrimary       Boolean      @default(false)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

////////////////////////////////////////////////////////////
/// ORGANIZATION BANK ACCOUNTS
////////////////////////////////////////////////////////////

model OrganizationBank {
  id              Int          @id @default(autoincrement())
  organizationId  String

  accountTitle    String
  bankName        String
  branchName      String?
  accountNumber   String
  iban            String?
  swiftCode       String?

  isPrimary       Boolean      @default(false)

  organization    Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

////////////////////////////////////////////////////////////
/// UNIT CODE SEQUENCE (Race-safe auto-increment per scope)
////////////////////////////////////////////////////////////

model UnitCodeSequence {
  id        String        @id @default(cuid())
  scopeType UnitScopeType
  scopeId   String?
  lastValue Int           @default(0)

  @@unique([scopeType, scopeId])
}

////////////////////////////////////////////////////////////
/// GEO HIERARCHY: Region → SubRegion → City → Zone
////////////////////////////////////////////////////////////

model Region {
  id       String @id @default(cuid())
  name     String
  unitCode String @unique @db.VarChar(5)

  subRegions SubRegion[]
  cities     City[]
}

model SubRegion {
  id       String @id @default(cuid())
  name     String
  unitCode String @db.VarChar(5)

  regionId String?
  region   Region? @relation(fields: [regionId], references: [id])

  cities City[]
}

model City {
  id       String @id @default(cuid())
  name     String
  unitCode String @unique @db.VarChar(5)

  regionId    String?
  subRegionId String?

  region    Region?    @relation(fields: [regionId], references: [id])
  subRegion SubRegion? @relation(fields: [subRegionId], references: [id])

  zones    Zone[]
  campuses Campus[]
}

model Zone {
  id       String @id @default(cuid())
  name     String
  unitCode String @db.VarChar(5)

  cityId String
  city   City @relation(fields: [cityId], references: [id])

  campuses Campus[]
}

////////////////////////////////////////////////////////////
/// CAMPUS (Operational Unit)
////////////////////////////////////////////////////////////

model Campus {
  id                Int             @id @default(autoincrement())
  organizationId    String          @db.VarChar(11)
  organization      Organization    @relation(fields: [organizationId], references: [id])
  name              String
  campusCode        String          @unique
  campusSlug        String          @unique
  unitCode          String          @db.VarChar(5)
  fullUnitPath      String          @db.VarChar(50)
  address           String?

  cityId            String
  city              City            @relation(fields: [cityId], references: [id])

  zoneId            String?
  zone              Zone?           @relation(fields: [zoneId], references: [id])

  principalName     String?
  contactPhone      String?
  email             String?
  academicStartMonth Int            @default(8)
  isMainCampus      Boolean         @default(false)
  status            String          @default("ACTIVE")
  createdAt         DateTime        @default(now())
  deletedAt         DateTime?

  memberships       Membership[]
  students          Student[]
  feeStructures     FeeStructure[]
  feeChallans       FeeChallan[]

  @@index([fullUnitPath])
}

////////////////////////////////////////////////////////////
/// MEMBERSHIP (TENANT RBAC BRIDGE)
////////////////////////////////////////////////////////////

model Membership {
  id              Int              @id @default(autoincrement())

  userId          Int
  organizationId  String

  role            MembershipRole
  status          MembershipStatus @default(ACTIVE)

  campusId        Int?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  user            User             @relation(fields: [userId], references: [id])
  organization    Organization     @relation(fields: [organizationId], references: [id])
  campus          Campus?          @relation(fields: [campusId], references: [id])

  @@unique([userId, organizationId])
  @@index([organizationId])
}

////////////////////////////////////////////////////////////
/// INVITATIONS
////////////////////////////////////////////////////////////

model Invitation {
  id              Int              @id @default(autoincrement())

  email           String
  organizationId  String
  role            MembershipRole

  token           String           @unique

  invitedById     Int
  invitedBy       User             @relation(fields: [invitedById], references: [id])

  expiresAt       DateTime
  acceptedAt      DateTime?

  organization    Organization     @relation(fields: [organizationId], references: [id])

  createdAt       DateTime         @default(now())

  @@index([organizationId])
}

////////////////////////////////////////////////////////////
/// PASSWORD RESET TOKENS
////////////////////////////////////////////////////////////

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation(fields: [userId], references: [id])
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
}

////////////////////////////////////////////////////////////
/// STUDENT
////////////////////////////////////////////////////////////

model Student {
  id             Int      @id @default(autoincrement())
  fullName       String
  admissionNo    String   @unique
  grade          String
  feeStatus      String   @default("Unpaid")

  organizationId String       @db.VarChar(11)
  organization   Organization @relation(fields: [organizationId], references: [id])
  campusId       Int
  campus         Campus       @relation(fields: [campusId], references: [id])

  feeChallans    FeeChallan[]
}

////////////////////////////////////////////////////////////
/// FEE MODULE
////////////////////////////////////////////////////////////

model FeeHead {
  id             Int          @id @default(autoincrement())
  organizationId String       @db.VarChar(11)
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  type           String
  isSystemDefault Boolean     @default(false)
  createdAt      DateTime     @default(now())

  structures     FeeStructure[]
}

model FeeStructure {
  id             Int          @id @default(autoincrement())
  organizationId String       @db.VarChar(11)
  campusId       Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  campus         Campus       @relation(fields: [campusId], references: [id])

  feeHeadId      Int
  feeHead        FeeHead      @relation(fields: [feeHeadId], references: [id])

  name           String
  amount         Decimal      @default(0.00)
  currency       String       @default("PKR")
  frequency      String

  applicableGrade String?

  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
}

model FeeChallan {
  id             Int          @id @default(autoincrement())
  organizationId String       @db.VarChar(11)
  campusId       Int
  studentId      Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  campus         Campus       @relation(fields: [campusId], references: [id])
  student        Student      @relation(fields: [studentId], references: [id])

  challanNo      String       @unique
  issueDate      DateTime     @default(now())
  dueDate        DateTime

  totalAmount    Decimal
  paidAmount     Decimal      @default(0.00)
  status         String       @default("UNPAID")

  paymentMethod  String?
  paidAt         DateTime?

  generatedBy    String
}

////////////////////////////////////////////////////////////
/// BACKGROUND JOB (Queue Audit Trail)
////////////////////////////////////////////////////////////

model Job {
  id             String    @id @default(cuid())
  type           String    // EMAIL, SMS, WHATSAPP, CHALLAN_PDF, REPORT, IMPORT, OTP
  queue          String    @default("default")
  payload        Json
  status         String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, DEAD
  priority       Int       @default(0)
  attempts       Int       @default(0)
  maxAttempts    Int       @default(3)
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  failedAt       DateTime?
  error          String?
  result         Json?

  organizationId String?   @db.VarChar(11)
  userId         Int?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization? @relation(fields: [organizationId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])

  @@index([status, scheduledAt])
  @@index([type, status])
  @@index([organizationId])
  @@index([queue, priority])
}
